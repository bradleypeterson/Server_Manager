{% extends 'base.html' %}

{% block body %}
{% include 'navbar.html' %}
{#<form action="{% url 'addServer' %}" method="POST">#}
<form action="./" method="POST">
<div class="container mt-5 mb-5">
    <div class="p-4 shadow-sm login-form__content add-project-form">
        <h1 class="mb-3 text-center course-header" id="header">New Server</h1>
        <hr class="add-project-hr">
        {% csrf_token %}

        <!-- Display Django Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

        <!-- Display Form Errors -->
            {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Please fix the following errors:</strong>
                    <ul>
                        {% for field, errors in form.errors.items %}
                            <li><strong>{{ field|title }}:</strong> {{ errors|join:", " }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">

                <div class="mb-3">
                    <label for="name" class="form-label">Server Name</label>
                    {{ form.name }}
                </div>

                <div class="mb-3">
                    <label for="operating_system" class="form-label">Operating System</label>
                    {{ form.operating_system }}
                </div>

                <div class="mb-3">
                    <label for="software_installed" class="form-label">Software Installed</label>
                    {{ form.software_installed }}
                </div>
                <div class="mb-3">
                    <label for="project" class="form-label">Project</label>
                    {{ form.project }}
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-primary" onclick="ping()">Ping</button>
                    <span id="ping_result"></span>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">

                <div class="mb-3">
                    <label for="ip_address" class="form-label">IP Address</label>
                    {{ form.ip_address }}
                </div>

                <div class="mb-3">
                    <label for="idrac_info" class="form-label">iDRAC Info</label>
                    {{ form.idrac_info }}
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    {{ form.notes }}
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="mb-3">
            <label for="project_purpose" class="form-label">Description</label>
            {{ form.description }}
        </div>

        <!-- Custom Fields -->
        <h3>Custom Fields</h3>
        <div id="custom-fields" class="row"></div>
        <button type="button" class="btn btn-secondary mb-3" onclick="addCustomField()">Add Custom Field</button>
        <div class="text-center">
            <button id="submit" type="submit" class="add-project-button">Add Server</button>
            <button id="cancel" type="button" onclick="window.location.href='{% url 'home' %}'" class="cancel-project-button">Cancel</button>
        </div>
    </div>
</div>
</form>

<script>
function addCustomField() {
    let container = document.getElementById("custom-fields");
    let div = document.createElement("div");
    div.classList.add("col-md-6", "mb-3");
    div.innerHTML = `
        <input type="text" class="form-control" name="custom_field_names[]" placeholder="Field Name" required>
        <input type="text" class="form-control" name="custom_field_values[]" placeholder="Field Value">
        <button type="button" class="btn btn-danger btn-sm" onclick="removeCustomField(this)">Remove</button>
    `;
    container.appendChild(div);
}

function removeCustomField(button) {
    button.parentElement.remove();
}


{% if edit %}
    document.getElementById("header").innerText = "Edit Server"
    document.getElementById("submit").innerText = "Save Changes"
    document.getElementById("cancel").innerText = "Return to Homepage"
{% endif %}

function ping(button) {
    console.log("Ping button clicked!");

    let ip_address_element = document.getElementById("id_ip_address");
    let ping_result = document.getElementById("ping_result");
    console.log("IP Address Element:", ip_address_element);

    let ip_address = ip_address_element.value;
    console.log("IP Addy: ",ip_address);


    if (!ip_address) {
        ping_result.textContent = "Please enter an IP address";
        ping_result.style.color = "red";
        return;
    }

    ping_result.textContent = "Pinging...";
    ping_result.style.color = "black";

    fetch("{% url 'pingServer' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ ip_address: ip_address })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "active") {
            ping_result.textContent = "Active";
            ping_result.style.color = "green";
        } else {
            ping_result.textContent = "Inactive";
            ping_result.style.color = "red";
        }
    })
    .catch(error => {
        ping_result.textContent = "Error!";
        ping_result.style.color = "red";
    });
}

</script>
{% endblock %}